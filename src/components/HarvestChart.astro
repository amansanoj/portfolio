---
// Harvest data for the chart
const data = {
  labels: ['2016–17', '2017–18', '2018–19', '2019–20', '2020–21', '2021–22', '2022–23', '2023–24'],
  values: [2500, 4200, 6000, 10600, 15000, 20000, 50000, 100000]
};
---

<div class="harvest-chart-wrapper">
  <canvas id="harvestChart"></canvas>
</div>

<script>
  import { Chart, BarController, BarElement, CategoryScale, LinearScale, Tooltip } from 'chart.js';
  
  Chart.register(BarController, BarElement, CategoryScale, LinearScale, Tooltip);

  const canvas = document.getElementById('harvestChart') as HTMLCanvasElement;
  if (!canvas) throw new Error('Canvas not found');

  const ctx = canvas.getContext('2d');
  if (!ctx) throw new Error('Canvas context not found');

  // Get accent color from CSS
  const accentColor = getComputedStyle(document.documentElement)
    .getPropertyValue('--accent').trim() || '#156bb3';
  const accentDark = getComputedStyle(document.documentElement)
    .getPropertyValue('--accent-dark').trim() || '#0f5ba8';

  const isDark = document.documentElement.getAttribute('data-theme') === 'dark';

  const chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['2016–17', '2017–18', '2018–19', '2019–20', '2020–21', '2021–22', '2022–23', '2023–24'],
      datasets: [{
        label: 'Annual Produce (kg)',
        data: [2500, 4200, 6000, 10600, 15000, 20000, 50000, 100000],
        backgroundColor: accentColor,
        hoverBackgroundColor: accentDark,
        borderRadius: 4,
        borderSkipped: false,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          backgroundColor: isDark ? '#1a1a1a' : '#2a2a2a',
          titleColor: '#fff',
          bodyColor: '#fff',
          padding: 12,
          displayColors: false,
          callbacks: {
            label: (context) => context.parsed.y != null ? `${context.parsed.y.toLocaleString()} kg` : ''
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          grid: {
            color: isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)'
          },
          ticks: {
            color: isDark ? 'rgba(255,255,255,0.6)' : 'rgba(0,0,0,0.6)',
            callback: (value) => `${(value as number / 1000).toFixed(0)}k`
          }
        },
        x: {
          grid: {
            display: false
          },
          ticks: {
            color: isDark ? 'rgba(255,255,255,0.6)' : 'rgba(0,0,0,0.6)',
            font: {
              size: 11
            }
          }
        }
      }
    }
  });

  // Update chart when theme changes
  const observer = new MutationObserver(() => {
    const newIsDark = document.documentElement.getAttribute('data-theme') === 'dark';
    if (chart.options.scales?.y?.grid && chart.options.scales?.x?.ticks) {
      chart.options.scales.y.grid.color = newIsDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)';
      if (chart.options.scales.y.ticks) {
        chart.options.scales.y.ticks.color = newIsDark ? 'rgba(255,255,255,0.6)' : 'rgba(0,0,0,0.6)';
      }
      if (chart.options.scales.x.ticks) {
        chart.options.scales.x.ticks.color = newIsDark ? 'rgba(255,255,255,0.6)' : 'rgba(0,0,0,0.6)';
      }
      if (chart.options.plugins?.tooltip) {
        chart.options.plugins.tooltip.backgroundColor = newIsDark ? '#1a1a1a' : '#2a2a2a';
      }
      chart.update();
    }
  });

  observer.observe(document.documentElement, {
    attributes: true,
    attributeFilter: ['data-theme']
  });
</script>

<style>
  .harvest-chart-wrapper {
    margin: 2em 0;
    padding: 1.5em;
    background: rgb(var(--gray-light));
    border-radius: 12px;
    height: 300px;
  }

  @media (max-width: 520px) {
    .harvest-chart-wrapper {
      height: 250px;
      padding: 1em;
    }
  }
</style>
