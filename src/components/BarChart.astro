---

const { data } = Astro.props;
---

<div class="bar-chart-wrapper">
  <canvas id="BarChart" data-chart={JSON.stringify(data)}></canvas>
</div>

<script>

  import { Chart, BarController, BarElement, CategoryScale, LinearScale, Tooltip } from 'chart.js';
  Chart.register(BarController, BarElement, CategoryScale, LinearScale, Tooltip);

  const canvas = document.getElementById('BarChart');
  if (!(canvas instanceof HTMLCanvasElement)) throw new Error('Canvas not found or not a canvas element');
  const dataAttr = canvas.getAttribute('data-chart');
  if (!dataAttr) throw new Error('No data-chart attribute found');
  const data = JSON.parse(dataAttr);
  const ctx = canvas.getContext('2d');
  if (!ctx) throw new Error('Canvas context not found');

  // Get accent color from CSS
  const accentColor = getComputedStyle(document.documentElement)
    .getPropertyValue('--c-accent').trim() || '#156bb3';
  const accentDark = getComputedStyle(document.documentElement)
    .getPropertyValue('--c-accent-dark').trim() || '#0e4f87';

  const isDark = document.documentElement.getAttribute('data-theme') === 'dark';

  const chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: data.labels,
      datasets: [{
        label: 'Annual Produce (kg)',
        data: data.values,
        backgroundColor: accentColor,
        hoverBackgroundColor: accentDark,
        borderRadius: 4,
        borderSkipped: false,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          backgroundColor: isDark ? '#1a1a1a' : '#2a2a2a',
          titleColor: '#fff',
          bodyColor: '#fff',
          padding: 12,
          displayColors: false,
          callbacks: {
            label: (context) => context.parsed.y != null ? `${context.parsed.y.toLocaleString()} kg` : ''
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          grid: {
            color: isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)'
          },
          ticks: {
            color: isDark ? 'rgba(255,255,255,0.6)' : 'rgba(0,0,0,0.6)',
            callback: (value) => `${(Number(value) / 1000).toFixed(0)}k`
          }
        },
        x: {
          grid: {
            display: false
          },
          ticks: {
            color: isDark ? 'rgba(255,255,255,0.6)' : 'rgba(0,0,0,0.6)',
            font: {
              size: 11
            }
          }
        }
      }
    }
  });

  // Update chart when theme changes
  const observer = new MutationObserver(() => {
    const newIsDark = document.documentElement.getAttribute('data-theme') === 'dark';
    if (chart.options.scales?.y?.grid && chart.options.scales?.x?.ticks) {
      chart.options.scales.y.grid.color = newIsDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)';
      if (chart.options.scales.y.ticks) {
        chart.options.scales.y.ticks.color = newIsDark ? 'rgba(255,255,255,0.6)' : 'rgba(0,0,0,0.6)';
      }
      if (chart.options.scales.x.ticks) {
        chart.options.scales.x.ticks.color = newIsDark ? 'rgba(255,255,255,0.6)' : 'rgba(0,0,0,0.6)';
      }
      if (chart.options.plugins?.tooltip) {
        chart.options.plugins.tooltip.backgroundColor = newIsDark ? '#1a1a1a' : '#2a2a2a';
      }
      chart.update();
    }
  });

  observer.observe(document.documentElement, {
    attributes: true,
    attributeFilter: ['data-theme']
  });
</script>

<style>
  .bar-chart-wrapper {
    margin: 2em 0;
    padding: 1.5em;
    background: var(--c-surface);
    border-radius: 0.75rem;
    height: 300px;
  }

  @media (max-width: 520px) {
    .bar-chart-wrapper {
      height: 250px;
      padding: 1em;
    }
  }
</style>
